<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ§ï¸ Recomendaciones - PredicciÃ³n de PrecipitaciÃ³n estaciÃ³n P55</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container my-4">
        <h1 class="text-center mb-4">ğŸŒ¦ï¸ Recomendaciones - PredicciÃ³n de PrecipitaciÃ³n estaciÃ³n P55</h1>

        <div class="card mb-4">
            <div class="card-header">
                <h2>ğŸ“ UbicaciÃ³n de la EstaciÃ³n P55</h2>
            </div>
            <div class="card-body text-center">
                <p>ğŸ—ºï¸ Este mapa muestra la captaciÃ³n Diguchi (P55), se encuentran en la cuenca del Antisana, dentro del Ãrea de ConservaciÃ³n HÃ­drica (ACH) Antisana.</p>
                <img src="{{ url_for('static', filename='Imagen1.png') }}" alt="UbicaciÃ³n de la EstaciÃ³n P55_5" class="img-fluid border rounded shadow-sm">
            </div>
        </div>

        {# 
        <div class="card mb-4">
            <div class="card-header">
                <h2>ğŸ“Š MÃ©tricas de EvaluaciÃ³n del Modelo</h2>
            </div>
            <div class="card-body">
                <p>ğŸ“ˆ Estas mÃ©tricas reflejan el rendimiento del modelo Random Forest en el conjunto de prueba.</p>
                <ul class="list-group list-group-flush">
                    {% for key, value in metrics.items() %}
                        <li class="list-group-item"><strong>{{ key }}:</strong> {{ value }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h2>ğŸ“‰ GrÃ¡fico de Rendimiento del Modelo (Conjunto de Prueba)</h2>
            </div>
            <div class="card-body text-center">
                <p>ğŸ” Este grÃ¡fico compara la precipitaciÃ³n real observada con las predicciones generadas por el modelo Random Forest.</p>
                <img src="{{ url_for('static', filename='prediccion_precipitacion_ml_test.png') }}" alt="GrÃ¡fico de Predicciones en Prueba" class="img-fluid border rounded shadow-sm">
            </div>
        </div>
        #}

        <div class="card mb-4">
            <div class="card-header">
                <h2>ğŸ“… PatrÃ³n Estacional de PrecipitaciÃ³n</h2>
            </div>
            <div class="card-body text-center">
                <p>ğŸ“Š Este grÃ¡fico de barras muestra la precipitaciÃ³n promedio histÃ³rica por mes del aÃ±o en la estaciÃ³n P55.</p>
                <img src="{{ url_for('static', filename='precipitacion_mensual_promedio_barras.png') }}" alt="PrecipitaciÃ³n Promedio Mensual" class="img-fluid border rounded shadow-sm">
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h2>ğŸ“š Recomendaciones de la IA (HistÃ³ricas)</h2>
            </div>
            <div class="card-body">
                <p>ğŸ’¡ ObtÃ©n consejos de la IA basados en el patrÃ³n histÃ³rico de precipitaciÃ³n. Estas recomendaciones son clave para la planificaciÃ³n a largo plazo, entendiendo las tendencias climÃ¡ticas usuales de la regiÃ³n.</p>
                <button id="getAiHistoricalRecommendations" class="btn btn-info mb-3">ğŸ§  Obtener Recomendaciones HistÃ³ricas</button>
                <div id="aiHistoricalResponse" class="mt-3 p-3 border rounded bg-light text-secondary">
                    â³ Haz clic en el botÃ³n para generar las recomendaciones histÃ³ricas.
                </div>
            </div>
        </div>
        <div class="card mb-4">
            <div class="card-header">
                <h2>ğŸ”® Predicciones Futuras de PrecipitaciÃ³n</h2>
            </div>
            <div class="card-body">
                <p>ğŸ“† Tabla con los valores de precipitaciÃ³n para los prÃ³ximos <strong>{{ ANIOS_A_PREDECIR * 12 }}</strong> meses.</p>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    {{ predictions_html | safe }}
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h2>ğŸ“ˆ GrÃ¡fico de Predicciones Futuras - P55</h2>
            </div>
            <div class="card-body text-center">
                <p>ğŸ” VisualizaciÃ³n de los datos histÃ³ricos y la proyecciÃ³n del modelo Random Forest para los prÃ³ximos aÃ±os.</p>
                <img src="{{ url_for('static', filename='prediccion_precipitacion_ml_future.png') }}" alt="GrÃ¡fico de Predicciones Futuras" class="img-fluid border rounded shadow-sm">
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h2>ğŸ¤– Recomendaciones de la IA (Gemini)</h2>
            </div>
            <div class="card-body">
                <p>ğŸ’¡ ObtÃ©n recomendaciones personalizadas basadas en las predicciones de precipitaciÃ³n. La IA analizarÃ¡ los datos y ofrecerÃ¡ sugerencias Ãºtiles para agricultores y gestiÃ³n de recursos hÃ­dricos.</p>
                <button id="getAiRecommendations" class="btn btn-primary mb-3">ğŸ§  Obtener Recomendaciones</button>
                <div id="aiResponse" class="mt-3 p-3 border rounded bg-light text-secondary">
                    â³ Haz clic en el botÃ³n para generar las recomendaciones.
                </div>
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        document.getElementById('getAiRecommendations').addEventListener('click', function () {
            const aiResponseDiv = document.getElementById('aiResponse');
            aiResponseDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="sr-only">Cargando...</span></div> Generando recomendaciones... Esto puede tardar unos segundos.';

            fetch('/ask_ai', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                let formattedResponse = data.response.replace(/\n/g, '<br>');
                formattedResponse = formattedResponse.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
                aiResponseDiv.innerHTML = formattedResponse;
            })
            .catch(error => {
                console.error('Error:', error);
                aiResponseDiv.innerHTML = 'âŒ Error al obtener recomendaciones de la IA. Por favor, revisa la consola para mÃ¡s detalles.';
            });
        });

        // Script para las nuevas recomendaciones histÃ³ricas
        document.getElementById('getAiHistoricalRecommendations').addEventListener('click', function () {
            const aiHistoricalResponseDiv = document.getElementById('aiHistoricalResponse');
            aiHistoricalResponseDiv.innerHTML = '<div class="spinner-border text-info" role="status"><span class="sr-only">Cargando...</span></div> Generando recomendaciones histÃ³ricas... Esto puede tardar unos segundos.';

            fetch('/ask_ai_historical', { // AsegÃºrate de que tu endpoint de Flask se llame asÃ­
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                let formattedResponse = data.response.replace(/\n/g, '<br>');
                formattedResponse = formattedResponse.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
                aiHistoricalResponseDiv.innerHTML = formattedResponse;
            })
            .catch(error => {
                console.error('Error:', error);
                aiHistoricalResponseDiv.innerHTML = 'âŒ Error al obtener recomendaciones histÃ³ricas de la IA. Por favor, revisa la consola para mÃ¡s detalles.';
            });
        });
    </script>
</body>
</html>